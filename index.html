<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VoxelCraft</title>
<link rel="stylesheet" href="inventory.css">
</head>
<body>

<div id="crosshair">+</div>

<!-- HOTBAR -->
<div id="hotbar"></div>

<!-- INVENTORY -->
<div id="inventory" class="hidden">
  <div class="grid"></div>
</div>

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script>
// ================= BASIC =================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 500);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(100,200,100);
scene.add(sun);

// ================= INPUT =================
const keys = {};
addEventListener("keydown",e=>keys[e.code]=true);
addEventListener("keyup",e=>keys[e.code]=false);
document.body.onclick = ()=>document.body.requestPointerLock();

// ================= MOUSE =================
let yaw=0,pitch=0;
addEventListener("mousemove",e=>{
  if(document.pointerLockElement!==document.body)return;
  yaw -= e.movementX*0.002;
  pitch -= e.movementY*0.002;
  pitch = Math.max(-1.4, Math.min(1.4, pitch));
});

// ================= TEXTURES =================
function texture(c1,c2){
  const c=document.createElement("canvas");
  c.width=c.height=32;
  const x=c.getContext("2d");
  x.fillStyle=c1; x.fillRect(0,0,32,32);
  for(let i=0;i<200;i++){
    x.fillStyle=c2;
    x.fillRect(Math.random()*32,Math.random()*32,2,2);
  }
  const t=new THREE.CanvasTexture(c);
  t.magFilter=t.minFilter=THREE.NearestFilter;
  return t;
}

const BLOCK_MAT = [
  new THREE.MeshStandardMaterial({map:texture("#3aa655","#2e8b57")}),
  new THREE.MeshStandardMaterial({map:texture("#8b4513","#5c3317")}),
  new THREE.MeshStandardMaterial({map:texture("#888","#666")})
];

// ================= BLOCKS =================
const geo = new THREE.BoxGeometry(1,1,1);
const blocks = new Map();
const k=(x,y,z)=>`${x},${y},${z}`;

function addBlock(x,y,z,t){
  const m=new THREE.Mesh(geo,BLOCK_MAT[t]);
  m.position.set(x,y,z);
  m.userData.type=t;
  scene.add(m);
  blocks.set(k(x,y,z),m);
}

// ================= WORLD =================
function noise(x,z){
  return Math.sin(x*0.1)+Math.cos(z*0.1);
}
for(let x=-30;x<30;x++)
for(let z=-30;z<30;z++){
  const h=Math.floor(noise(x,z)*2+6);
  for(let y=0;y<=h;y++){
    addBlock(x,y,z,y==h?0:y>h-2?1:2);
  }
}

// ================= PLAYER =================
const player={
  pos:new THREE.Vector3(0,15,0),
  vel:new THREE.Vector3(),
  size:new THREE.Vector3(0.6,1.8,0.6),
  eye:1.6,
  onGround:false
};

function collide(pos,size){
  for(let x=Math.floor(pos.x-size.x/2);x<=Math.floor(pos.x+size.x/2);x++)
  for(let y=Math.floor(pos.y);y<=Math.floor(pos.y+size.y);y++)
  for(let z=Math.floor(pos.z-size.z/2);z<=Math.floor(pos.z+size.z/2);z++)
    if(blocks.has(k(x,y,z))) return true;
  return false;
}

// ================= INVENTORY DATA =================
const INVENTORY_SIZE = 36;
const inventory = Array(INVENTORY_SIZE).fill(null);
const MAX_STACK = 64;
let selected = 0;

// ================= UI =================
const hotbar = document.getElementById("hotbar");
const invGrid = document.querySelector(".grid");

function redrawInventory(){
  hotbar.innerHTML="";
  invGrid.innerHTML="";

  inventory.forEach((slot,i)=>{
    const d=document.createElement("div");
    d.className="slot"+(i===selected?" active":"");
    if(slot){
      d.innerText=slot.count;
      d.style.background=slot.color;
    }
    if(i<9) hotbar.appendChild(d);
    else invGrid.appendChild(d);
  });
}
redrawInventory();

// ================= ANIMAL (COW) =================
function Cow(x,z){
  const g=new THREE.Group();

  const body=new THREE.Mesh(
    new THREE.BoxGeometry(1.5,1,2.5),
    new THREE.MeshStandardMaterial({color:0x8b5a2b})
  );
  body.position.y=1;

  const head=new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({color:0x7a4a2e})
  );
  head.position.set(0,1.2,1.8);

  g.add(body,head);
  g.position.set(x,10,z);
  g.userData={velY:0,dir:Math.random()*Math.PI*2};

  scene.add(g);
  return g;
}

const mobs=[];
for(let i=0;i<6;i++){
  mobs.push(Cow(Math.random()*30-15,Math.random()*30-15));
}

// ================= LOOP =================
function animate(){
  requestAnimationFrame(animate);

  camera.rotation.order="YXZ";
  camera.rotation.y=yaw;
  camera.rotation.x=pitch;

  const forward=new THREE.Vector3();
  camera.getWorldDirection(forward);
  forward.y=0; forward.normalize();
  const right=new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0));

  let speed=0.08;
  const move=new THREE.Vector3();
  if(keys.KeyW) move.add(forward);
  if(keys.KeyS) move.sub(forward);
  if(keys.KeyA) move.sub(right);
  if(keys.KeyD) move.add(right);
  move.normalize().multiplyScalar(speed);

  player.pos.x+=move.x;
  if(collide(player.pos,player.size)) player.pos.x-=move.x;
  player.pos.z+=move.z;
  if(collide(player.pos,player.size)) player.pos.z-=move.z;

  player.vel.y-=0.02;
  player.pos.y+=player.vel.y;
  if(collide(player.pos,player.size)){
    player.pos.y-=player.vel.y;
    player.vel.y=0;
    player.onGround=true;
  } else player.onGround=false;

  if(keys.Space&&player.onGround) player.vel.y=0.35;

  mobs.forEach(m=>{
    m.userData.velY-=0.02;
    m.position.y+=m.userData.velY;
    if(m.position.y<2){m.position.y=2;m.userData.velY=0;}
    m.position.x+=Math.sin(m.userData.dir)*0.02;
    m.position.z+=Math.cos(m.userData.dir)*0.02;
    if(Math.random()<0.01) m.userData.dir+=Math.random()-0.5;
  });

  camera.position.set(player.pos.x,player.pos.y+player.eye,player.pos.z);
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
